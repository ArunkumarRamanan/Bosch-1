# Libraries

library(data.table)
library(Matrix)
library(recommenderlab)
library(Laurae)
library(fastdigest)
library(pbapply)
library(ggplot2)
library(R.utils)
library(stringi)

setwd("E:/")

my_script_is_using <- "E:/Laurae/20161031_lgbm_jayjay_laurae_top100"
my_lgbm_is_at <- "C:/Compiled/LightGBM/windows/x64/Release/lightgbm.exe"
my_script_subbed <- basename(my_script_is_using)
threads <- 12
leaves <- 255
eta <- 0.05
min_sample <- 100
min_hess <- 10
subsample <- 1.0
colsample <- 1.0
sampling_freq <- ifelse(subsample == 1, 0, 1)


# Load from RDS
train_numeric <- readRDS("Laurae/DatesSpotting/train_dedup.rds")
test_numeric <- readRDS("Laurae/DatesSpotting/test_dedup.rds")
to_keep <- c("L3_S32_F3850_-1", "L3_S33_F3855_-1", "L1_S24_F1846", "L3_S30_F3804_2", 
             "L3_S33_F3873", "L0_S0_F20_3", "L1_S24_F1844_3", "L3_S30_F3774", 
             "L3_S33_F3871", "L3_S30_F3809", "L3_S38_F3952_-1", "L1_S24_F1581", 
             "L1_S24_F1632", "L1_S24_F1672", "L3_S33_F3859_2", "L1_S24_F1842_3", 
             "L3_S36_F3920_4", "L3_S30_F3494_5", "L3_S33_F3865_10", "L3_S29_F3407_2", 
             "L3_S29_F3339_2", "L3_S33_F3859_5", "L3_S30_F3759_7", "L3_S33_F3859_4", 
             "L3_S29_F3324", "L3_S33_F3857_9", "L3_S30_F3819", "L0_S0_F16_7", 
             "L3_S30_F3804_7", "L3_S29_F3373_5", "L0_S2_F44_2", "L1_S24_F1723_2", 
             "L3_S29_F3354_2", "L3_S30_F3514_2", "L3_S30_F3769_4", "L3_S33_F3869", 
             "L0_S0_F22_3", "L3_S30_F3749_6", "L0_S12_F350_3", "L3_S30_F3769_2", 
             "L0_S2_F60", "L3_S30_F3784_2", "L3_S30_F3769_5", "L3_S29_F3327_2", 
             "L3_S29_F3318_3", "L3_S33_F3857_3", "L3_S30_F3749_20", "L3_S30_F3799", 
             "L3_S29_F3357_2", "L3_S30_F3764", "L2_S26_F3047", "L3_S33_F3857_6", 
             "L0_S0_F18_14", "L3_S30_F3544_4", "L3_S30_F3574_6", "L3_S30_F3759_27", 
             "L3_S30_F3609_6", "L3_S29_F3351_8", "L3_S30_F3604_5", "L3_S29_F3433", 
             "L0_S1_F28_6", "L3_S29_F3479_11", "L3_S33_F3865_13", "L3_S30_F3609_4", 
             "L1_S24_F1758", "L3_S29_F3330_2", "L3_S30_F3794_5", "L3_S30_F3524_2", 
             "L3_S30_F3554_4", "L3_S29_F3379_4", "L3_S30_F3744_18", "L1_S24_F1700", 
             "L0_S7_F138_23", "L3_S33_F3865_4", "L3_S30_F3754_11", "L3_S30_F3534_5", 
             "L3_S29_F3321_4", "L0_S1_F24_4", "L3_S29_F3351_9", "L0_S1_F28_17", 
             "L3_S30_F3754_3", "L3_S34_F3876", "L3_S30_F3709_2", "L3_S30_F3794_3", 
             "L3_S30_F3604_9", "L3_S29_F3315_4", "L3_S29_F3336_8", "L3_S29_F3327_16", 
             "L3_S30_F3509_2", "L3_S30_F3759_4", "L3_S30_F3829_8", "L3_S30_F3744_21", 
             "L3_S29_F3479_6", "L3_S30_F3744_20", "L3_S34_F3882", "L3_S29_F3354_3",
             "L3_S30_F3624_2", "L0_S2_F36_6", "L1_S24_F1516", "L3_S29_F3427_6")
             # "L3_S29_F3336_9", "L3_S30_F3794_4", "L3_S30_F3754_19", "L0_S6_F122_6", 
             # "L3_S30_F3749_32", "L3_S36_F3920_3", "L3_S29_F3473_2", "L3_S33_F3857_15", 
             # "L0_S0_F16_3", "L3_S30_F3754_23", "L3_S29_F3382_13", "L3_S30_F3554_15", 
             # "L3_S30_F3754_15", "L3_S29_F3436_2", "L3_S30_F3704_6", "L0_S1_F24_17", 
             # "L1_S24_F1578_6", "L1_S24_F1850_7", "L3_S29_F3333_9", "L2_S26_F3117_15", 
             # "L0_S0_F18_5", "L3_S30_F3639_10", "L3_S29_F3333_8", "L3_S29_F3333_4", 
             # "L3_S30_F3574_5", "L3_S29_F3376_8", "L3_S30_F3534_11", "L3_S30_F3554_14", 
             # "L3_S30_F3829_19", "L0_S12_F352_3", "L3_S29_F3342_30", "L1_S24_F1514_7", 
             # "L3_S30_F3504_4", "L3_S29_F3345_29", "L3_S29_F3382_11", "L3_S30_F3759_19", 
             # "L0_S3_F96_6", "L3_S29_F3339_25", "L3_S29_F3479_4", "L1_S24_F1518_9", 
             # "L3_S30_F3804_6", "L3_S30_F3749_27", "L3_S33_F3857_7", "L1_S24_F1831", 
             # "L3_S30_F3759_25", "L3_S29_F3376_9", "L1_S24_F1494", "L3_S30_F3519_7", 
             # "L3_S30_F3554_9", "L0_S10_F219_4", "L3_S30_F3519_3", "L3_S30_F3784_3", 
             # "L3_S30_F3749_26", "L3_S35_F3896_10", "L3_S30_F3674", "L3_S29_F3376_4", 
             # "L0_S3_F84_5", "L3_S30_F3494_2", "L3_S30_F3744_2", "L0_S6_F132_9", 
             # "L0_S10_F254_3", "L1_S24_F1490", "L3_S30_F3494_4", "L2_S26_F3113_5", 
             # "L0_S3_F72_8", "L3_S33_F3857_13", "L3_S29_F3373_3", "L0_S13_F356_15", 
             # "L3_S29_F3351_5", "L3_S29_F3430_2", "L0_S7_F142_3", "L3_S30_F3534_6", 
             # "L2_S26_F3106_20", "L3_S30_F3554_13", "L3_S30_F3519_6", "L3_S29_F3345_19", 
             # "L2_S26_F3121_3", "L0_S3_F80_11", "L3_S29_F3379_5", "L3_S30_F3634_5", 
             # "L3_S30_F3629_11", "L0_S0_F2_16", "L1_S24_F1498", "L3_S30_F3644_5", 
             # "L3_S30_F3629_13", "L3_S30_F3564_3", "L3_S30_F3744_15", "L0_S1_F24_16", 
             # "L0_S1_F24_14", "L3_S30_F3629_6", "L0_S9_F165_7", "L0_S0_F20_2", 
             # "L0_S11_F294_7", "L3_S29_F3373_4", "L3_S30_F3574_2", "L3_S30_F3749_33", 
             # "L3_S30_F3669_11", "L3_S29_F3427_9", "L3_S30_F3744_14", "L0_S6_F132_6", 
             # "L3_S30_F3664", "L3_S30_F3639_2", "L3_S30_F3584", "L0_S10_F229_2", 
             # "L3_S29_F3479_5", "L3_S30_F3759_18", "L0_S9_F170_15", "L3_S30_F3829_6", 
             # "L0_S19_F455_13", "L3_S30_F3709_4", "L3_S29_F3376_3", "L3_S29_F3427_7", 
             # "L3_S36_F3920_8", "L3_S30_F3669_8", "L3_S38_F3952_5", "L0_S0_F0_9", 
             # "L3_S35_F3889_10", "L3_S29_F3382_4", "L3_S29_F3336_4", "L0_S11_F326_14", 
             # "L3_S29_F3330_9", "L0_S12_F332_13", "L0_S1_F28_14", "L3_S29_F3379_2", 
             # "L0_S5_F114_4", "L3_S29_F3473_7", "L0_S3_F80_3", "L0_S5_F116_14", 
             # "L3_S30_F3609_2", "L0_S9_F185_14", "L3_S30_F3804_5", "L3_S29_F3339_30", 
             # "L3_S30_F3574_7", "L1_S24_F679_3", "L2_S26_F3073_18", "L3_S38_F3956_2", 
             # "L0_S12_F330_17", "L3_S38_F3960_8", "L3_S29_F3342_2", "L3_S30_F3639_9", 
             # "L0_S0_F0_11", "L3_S38_F3956_3", "L0_S2_F64_2", "L3_S29_F3479_12", 
             # "L3_S29_F3348_24", "L3_S29_F3327_8", "L3_S29_F3351_7", "L3_S29_F3336_5", 
             # "L2_S27_F3210_3", "L2_S27_F3133_9", "L0_S2_F64_5", "L0_S15_F403_6", 
             # "L1_S24_F829_9", "L1_S25_F2126_2", "L3_S30_F3514_4", "L0_S5_F116_7", 
             # "L0_S2_F48_5", "L0_S14_F390_3", "L3_S30_F3624_3", "L3_S30_F3689_9", 
             # "L0_S6_F122_17", "L0_S1_F28_18", "L3_S30_F3754_8", "L3_S35_F3889_8", 
             # "L0_S5_F114_9", "L3_S29_F3382_7", "L2_S27_F3162_2", "L0_S1_F24_13", 
             # "L0_S11_F302_3", "L0_S3_F72_3", "L0_S0_F10_17", "L3_S30_F3759_20", 
             # "L0_S5_F116_10", "L0_S14_F370_5", "L0_S0_F2_11", "L3_S29_F3360", 
             # "L3_S33_F3857_14", "L3_S29_F3321_7", "L0_S10_F244_9", "L2_S26_F3121_9", 
             # "L3_S29_F3348_5", "L0_S6_F122_12", "L0_S3_F100_15", "L3_S30_F3579_4", 
             # "L3_S29_F3348_7", "L0_S9_F155_11", "L0_S1_F28_9", "L0_S10_F229_4", 
             # "L3_S30_F3754_5", "L3_S29_F3315_5", "L3_S29_F3348_18", "L3_S29_F3407_3", 
             # "L1_S24_F1520_3", "L0_S9_F200_14", "L3_S30_F3579_6", "L3_S30_F3749_3", 
             # "L0_S2_F36_4", "L3_S30_F3749_12", "L3_S30_F3829_3", "L0_S15_F397_8", 
             # "L1_S24_F1798_2", "L3_S29_F3342_26", "L2_S27_F3210_9", "L0_S0_F8_21", 
             # "L0_S0_F0_14", "L3_S29_F3327_17", "L0_S19_F459_9", "L0_S4_F109_16", 
             # "L3_S30_F3744_6", "L0_S0_F2_9", "L3_S29_F3330_8", "L0_S13_F354_42", 
             # "L3_S29_F3473_6", "L3_S29_F3327_11", "L3_S29_F3476_4", "L0_S0_F0_13", 
             # "L3_S30_F3504_9", "L0_S7_F142_5", "L3_S30_F3749_8", "L3_S35_F3896_8", 
             # "L0_S4_F109_4", "L0_S12_F332_9", "L3_S30_F3524_3", "L0_S12_F330_19", 
             # "L0_S11_F318_37", "L3_S34_F3880", "L3_S30_F3509_3", "L2_S27_F3214_19", 
             # "L3_S29_F3336_7", "L1_S24_F1573_18", "L1_S24_F1102", "L2_S26_F3040_12", 
             # "L0_S6_F122_4", "L0_S11_F322_3", "L1_S24_F1609_3", "L0_S3_F100_7", 
             # "L0_S10_F274", "L2_S27_F3199_18", "L2_S26_F3040_16", "L3_S30_F3519_4", 
             # "L3_S35_F3896_11", "L0_S9_F155_4", "L3_S30_F3704_34", "L3_S30_F3759_13", 
             # "L3_S33_F3865_8", "L0_S12_F348_6", "L1_S24_F1275", "L0_S23_F639_2", 
             # "L3_S35_F3894_3", "L0_S3_F96_2", "L3_S29_F3382_5", "L0_S22_F556_5", 
             # "L3_S47_F4163", "L3_S29_F3348_22", "L3_S41_F4026_22", "L1_S24_F1829_6", 
             # "L3_S29_F3321_2", "L2_S26_F3073_21", "L3_S29_F3357_4", "L0_S3_F80_8", 
             # "L0_S14_F362_3", "L3_S36_F3920_9", "L0_S0_F16_6", "L0_S11_F286_2", 
             # "L1_S24_F1685_5", "L3_S29_F3321_6", "L3_S30_F3604_11", "L1_S24_F1803", 
             # "L3_S32_F3850_9", "L0_S6_F132_3", "L0_S12_F346_11", "L0_S6_F132_4", 
             # "L3_S30_F3749_17", "L1_S24_F1685_24", "L3_S30_F3534_3", "L3_S29_F3348_10", 
             # "L1_S24_F1652_2", "L0_S9_F195_16", "L2_S27_F3144_4", "L3_S30_F3534_9", 
             # "L1_S24_F1667_3", "L3_S29_F3345_3", "L0_S5_F116_3", "L3_S38_F3960_2", 
             # "L3_S29_F3330_12", "L3_S35_F3896_5", "L1_S24_F1176_21", "L3_S29_F3473_4", 
             # "L3_S30_F3829_16", "L0_S23_F671_13", "L3_S30_F3629_3", "L1_S24_F1713_3", 
             # "L1_S25_F2136", "L0_S7_F138_3", "L2_S26_F3062_31", "L3_S36_F3918_11", 
             # "L3_S30_F3669_2", "L3_S45_F4124_3", "L0_S12_F332_30", "L0_S1_F24_9", 
             # "L3_S40_F3980_3", "L3_S30_F3639_4", "L3_S40_F3982", "L3_S29_F3382_10",
             # "L3_S30_F3759_22", "L1_S24_F1753_7", "L0_S0_F22_2", "L0_S11_F286_14", 
             # "L0_S11_F290_3", "L3_S38_F3960_6", "L0_S11_F310_4", "L0_S3_F100_11", 
             # "L0_S0_F2_3", "L1_S24_F816_5", "L0_S13_F356_3", "L3_S30_F3749_30", 
             # "L2_S27_F3206_3", "L0_S5_F114_15", "L3_S29_F3351_4", "L3_S30_F3589_8", 
             # "L3_S35_F3889_5", "L0_S0_F8_23", "L0_S17_F431_10", "L0_S18_F439_15", 
             # "L1_S25_F1858_4", "L1_S24_F1788_2", "L0_S18_F439_10", "L2_S26_F3036_16", 
             # "L0_S0_F2_14", "L3_S38_F3952_4", "L3_S29_F3333_7", "L3_S48_F4196_8", 
             # "L0_S11_F326_3", "L0_S5_F114_14", "L3_S40_F3986_3", "L3_S29_F3482", 
             # "L3_S47_F4158_4", "L1_S24_F1565_21", "L0_S0_F6_16", "L3_S30_F3679_11", 
             # "L1_S24_F1822_2", "L3_S29_F3315_3", "L2_S27_F3166_3", "L0_S14_F370_2", 
             # "L0_S0_F2_15", "L1_S25_F3009_2", "L2_S27_F3140_5", "L3_S36_F3938", 
             # "L3_S29_F3345_14", "L0_S12_F330_35", "L0_S18_F449_7", "L2_S27_F3166_8", 
             # "L3_S33_F3865_12", "L2_S27_F3206_9", "L3_S30_F3749_29", "L3_S35_F3894_5", 
             # "L3_S29_F3476_15", "L3_S30_F3829_9", "L3_S29_F3427_4", "L0_S4_F104_11", 
             # "L3_S48_F4198_4", "L3_S35_F3889_11", "L0_S3_F84_4", "L3_S30_F3759_9", 
             # "L0_S16_F421_31", "L0_S2_F64_7", "L1_S24_F1848_6", "L0_S0_F4_4", 
             # "L2_S27_F3162_7", "L0_S13_F354_9", "L0_S0_F14_34", "L0_S14_F386_2", 
             # "L3_S29_F3345_25", "L3_S29_F3330_13", "L1_S24_F1695", "L0_S0_F10_9", 
             # "L2_S26_F3062_17", "L1_S24_F1520_6", "L2_S26_F3062_12", "L0_S3_F72_6", 
             # "L0_S9_F180_13", "L3_S29_F3348_17", "L3_S30_F3704_29", "L2_S26_F3113_4", 
             # "L0_S11_F282_6", "L3_S30_F3589_9", "L3_S33_F3867", "L3_S29_F3376_7", 
             # "L0_S22_F551_21", "L1_S24_F1637_23", "L1_S25_F1855_2", "L0_S11_F282_10", 
             # "L0_S11_F290_6", "L1_S24_F1824_3", "L0_S9_F180_12", "L0_S12_F342_4", 
             # "L0_S3_F96_7", "L1_S24_F1098", "L2_S26_F3062_6", "L0_S0_F6_4", 
             # "L3_S29_F3430_8", "L2_S26_F3106_21", "L0_S12_F330_4", "L0_S11_F286_23", 
             # "L1_S24_F1818_5", "L3_S47_F4158_2", "L3_S29_F3345_30", "L0_S0_F18_15", 
             # "L0_S17_F433_12", "L0_S0_F12_36", "L3_S30_F3754_18", "L3_S30_F3544_2", 
             # "L0_S11_F314_32", "L3_S30_F3744_17", "L0_S13_F354_5", "L0_S10_F219_3", 
             # "L3_S30_F3579_9", "L1_S25_F2116_7", "L3_S30_F3754_20", "L2_S27_F3166_21", 
             # "L0_S0_F18_2", "L3_S30_F3679_8", "L3_S30_F3744_11", "L0_S9_F210_2", 
             # "L3_S30_F3569_2", "L1_S24_F1637_15", "L0_S1_F28_4", "L3_S29_F3436_13", 
             # "L0_S21_F507_13", "L1_S24_F1184", "L1_S24_F1773_11", "L2_S27_F3155_31", 
             # "L3_S41_F4008_14", "L3_S30_F3579_8", "L2_S26_F3125", "L0_S23_F671_7", 
             # "L3_S29_F3436_12", "L2_S26_F3121_12", "L0_S22_F546_5", "L0_S0_F0_7", 
             # "L3_S29_F3436_8", "L1_S24_F1567_29", "L2_S27_F3162_14", "L0_S23_F659_14", 
             # "L3_S30_F3744_12", "L0_S15_F418_5", "L0_S23_F643_9", "L3_S30_F3514_5", 
             # "L2_S27_F3206_8", "L0_S21_F487_5", "L0_S0_F8_25", "L1_S24_F1728_41", 
             # "L0_S11_F282_9", "L0_S2_F64_11", "L0_S3_F96_4", "L1_S24_F1738_9", 
             # "L3_S30_F3759_11", "L2_S26_F3069_26", "L1_S24_F1565_20", "L3_S30_F3504_7", 
             # "L0_S15_F403_2", "L3_S30_F3829_13", "L1_S24_F1662_7", "L3_S30_F3534_10", 
             # "L3_S29_F3339_27", "L0_S10_F224_17", "L0_S11_F326_31", "L3_S29_F3476_6", 
             # "L0_S4_F104_21", "L1_S24_F733_3", "L0_S11_F302_6", "L1_S25_F2176_7", 
             # "L0_S3_F100_13", "L2_S27_F3140_2", "L1_S24_F998_11", "L0_S3_F100_14", 
             # "L0_S17_F433_16", "L0_S4_F104_5", "L1_S25_F1978", "L3_S29_F3430_16", 
             # "L0_S10_F259_35", "L3_S29_F3345_13", "L0_S3_F100_5", "L0_S11_F318_12", 
             # "L1_S24_F1685_9", "L1_S24_F1381_6", "L0_S15_F415_4", "L0_S12_F348_22", 
             # "L0_S14_F386_3", "L1_S24_F1728_9", "L3_S29_F3348_4", "L1_S24_F1567_25", 
             # "L0_S12_F334_32", "L0_S9_F170_24", "L0_S2_F44_3", "L0_S12_F346_6", 
             # "L3_S30_F3589_7", "L3_S30_F3604_6", "L0_S13_F356_16", "L0_S11_F326_23", 
             # "L3_S35_F3889_2", "L0_S13_F356_17", "L0_S0_F14_8", "L3_S30_F3669_6", 
             # "L0_S9_F155_6", "L0_S7_F138_15", "L1_S24_F1571_18", "L2_S26_F3062_10", 
             # "L0_S10_F259_37", "L0_S5_F114_-1", "L1_S24_F1126_5", "L0_S10_F244_8", 
             # "L0_S11_F314_25", "L0_S0_F8_20", "L0_S15_F418_14", "L1_S24_F1763_0", 
             # "L2_S26_F3040_27", "L2_S27_F3144_3", "L0_S21_F487_18", "L0_S21_F487_6", 
             # "L0_S14_F362_2", "L0_S10_F259_38", "L0_S15_F397_4", "L0_S0_F2_6", 
             # "L0_S0_F12_8", "L2_S26_F3106_6", "L2_S26_F3077", "L1_S24_F1667_2", 
             # "L2_S27_F3162_6", "L0_S21_F497_3", "L0_S11_F282_16", "L1_S24_F687_6", 
             # "L1_S25_F2158_10", "L2_S26_F3036_15", "L0_S9_F190_6", "L0_S11_F286_18", 
             # "L1_S24_F1810", "L0_S11_F286_16", "L1_S24_F1662_4", "L0_S15_F403_7", 
             # "L3_S30_F3704_21", "L0_S14_F374_4", "L0_S11_F306_23", "L1_S24_F1512_3", 
             # "L1_S24_F1326", "L2_S26_F3069_22", "L0_S22_F611", "L0_S18_F449_4", 
             # "L3_S29_F3327_12", "L3_S30_F3704_10", "L3_S30_F3589_6", "L3_S29_F3342_28", 
             # "L0_S9_F190_10", "L1_S25_F2111_19", "L3_S45_F4124_2", "L3_S30_F3749_10", 
             # "L1_S24_F1778_11", "L0_S1_F28_19", "L0_S23_F619_7", "L1_S24_F1685_10", 
             # "L0_S20_F461_6", "L2_S27_F3155_30", "L1_S24_F897_4", "L0_S10_F264_11", 
             # "L1_S24_F1627_3", "L0_S21_F537", "L0_S11_F306_11", "L1_S24_F1544_2", 
             # "L3_S30_F3684_13", "L0_S9_F155_9", "L3_S40_F3984_4", "L3_S47_F4153_3", 
             # "L0_S19_F459_5", "L0_S9_F160_21", "L2_S27_F3144_8", "L0_S12_F350_2", 
             # "L0_S7_F142_8", "L0_S12_F344_22", "L0_S5_F114_8", "L3_S30_F3689_3", 
             # "L0_S22_F561_9", "L0_S11_F322_7", "L1_S24_F1575_28", "L2_S27_F3133_18", 
             # "L0_S18_F439_3", "L0_S9_F190_8", "L0_S10_F249_15", "L0_S23_F655_8", 
             # "L0_S10_F259_33", "L0_S4_F109_29", "L0_S7_F138_13", "L1_S24_F1812_11", 
             # "L0_S9_F170_5", "L3_S41_F4011_14", "L0_S12_F348_18", "L1_S24_F1718_5", 
             # "L3_S30_F3639_7", "L2_S26_F3069_15", "L0_S17_F433_26", "L0_S12_F348_4", 
             # "L0_S10_F264_17", "L3_S29_F3476_3", "L1_S24_F1565_7", "L0_S21_F477_8", 
             # "L0_S2_F64_12", "L0_S0_F14_14", "L1_S24_F1565_18", "L1_S24_F1850_5", 
             # "L3_S29_F3327_5", "L0_S10_F234_7", "L0_S22_F596_20", "L1_S25_F1973", 
             # "L3_S29_F3476_14", "L1_S25_F1858_2", "L1_S24_F1567_28", "L0_S9_F160_3", 
             # "L0_S4_F104_6", "L2_S27_F3129_15", "L0_S12_F346_27", "L3_S30_F3704_35", 
             # "L0_S0_F14_42", "L3_S29_F3330_5", "L0_S10_F254_7", "L0_S0_F10_12", 
             # "L0_S9_F195_21", "L0_S11_F294_20", "L3_S41_F4006_4", "L0_S2_F36_8", 
             # "L3_S30_F3749_22", "L1_S24_F1506_7", "L1_S24_F1578_3", "L1_S24_F1544_4", 
             # "L3_S32_F3850_11", "L0_S10_F224_8", "L0_S4_F104_12", "L3_S29_F3436_9", 
             # "L3_S29_F3382_12", "L0_S10_F249_29", "L1_S25_F2147_5", "L2_S27_F3199_12", 
             # "L3_S29_F3461_17", "L1_S25_F2056", "L0_S13_F354_34", "L3_S29_F3348_26", 
             # "L0_S10_F224_11", "L0_S0_F12_35", "L2_S26_F3040_6", "L2_S28_F3255_6", 
             # "L0_S10_F249_27", "L0_S11_F310_15", "L2_S27_F3129_14", "L0_S10_F224_12", 
             # "L0_S15_F415_2", "L3_S35_F3896_2", "L0_S0_F12_6", "L3_S36_F3926", 
             # "L1_S24_F1718_4", "L3_S30_F3684_6", "L0_S12_F346_4", "L1_S24_F1520_10", 
             # "L3_S29_F3348_25", "L0_S10_F219_5", "L0_S16_F421_21", "L1_S24_F1520_11", 
             # "L0_S9_F185_21", "L1_S25_F2920_5", "L0_S9_F170_16", "L0_S11_F294_8", 
             # "L0_S19_F455_10", "L3_S41_F4014_11", "L1_S24_F867_2", "L1_S25_F2131_9", 
             # "L0_S4_F104_8", "L0_S9_F195_7", "L2_S26_F3069_16", "L3_S30_F3754_22", 
             # "L3_S29_F3339_20", "L3_S30_F3709_6", "L0_S0_F18_12", "L3_S29_F3339_13", 
             # "L1_S24_F1571_32", "L1_S24_F1518_12", "L0_S11_F294_22", "L3_S30_F3554_7", 
             # "L0_S7_F138_20", "L2_S26_F3069_12", "L3_S37_F3950", "L3_S47_F4153_7", 
             # "L1_S24_F1180_4", "L3_S29_F3342_19", "L3_S30_F3684_8", "L3_S29_F3436_5", 
             # "L0_S11_F318_32", "L0_S21_F512_25", "L0_S14_F390_12", "L0_S0_F4_16", 
             # "L0_S7_F142_16", "L0_S5_F116_15", "L3_S41_F4020_6", "L2_S26_F3069_10", 
             # "L1_S24_F1122_4", "L3_S36_F3918_13", "L3_S30_F3829_15", "L0_S10_F229_5", 
             # "L0_S23_F651_6", "L3_S40_F3984_2", "L3_S41_F4018_18", "L0_S3_F80_10", 
             # "L3_S36_F3918_8", "L0_S0_F8_24", "L2_S26_F3051_9", "L3_S43_F4095_4", 
             # "L0_S10_F244_11", "L0_S23_F671_8", "L0_S23_F623_12", "L3_S29_F3430_17", 
             # "L0_S2_F48_4", "L0_S1_F24_8", "L0_S3_F72_4", "L3_S29_F3345_16", 
             # "L3_S29_F3430_5", "L0_S23_F663_9", "L1_S25_F2071_25", "L3_S30_F3629_9", 
             # "L1_S24_F1748_3", "L0_S22_F591_10", "L3_S29_F3488", "L3_S29_F3342_20", 
             # "L1_S24_F1565_5", "L0_S10_F244_2", "L3_S30_F3684_3", "L0_S16_F421_34", 
             # "L0_S9_F160_15", "L2_S26_F3051_7", "L3_S41_F4004_3", "L0_S12_F330_34", 
             # "L0_S15_F415_6", "L0_S23_F623_6", "L0_S11_F306_19", "L0_S3_F80_7", 
             # "L0_S3_F100_17", "L2_S26_F3073_8", "L0_S22_F591_12", "L3_S30_F3679_2", 
             # "L0_S11_F322_4", "L0_S0_F0_15", "L2_S26_F3062_33", "L2_S27_F3162_13", 
             # "L3_S30_F3639_11", "L3_S33_F3855_4", "L1_S24_F1575_15", "L3_S30_F3554_10", 
             # "L0_S18_F439_6", "L1_S25_F2167", "L0_S17_F433_27", "L3_S29_F3345_17", 
             # "L0_S9_F200_21", "L0_S12_F332_31", "L3_S43_F4085_4", "L0_S0_F0_4", 
             # "L2_S26_F3069_7", "L3_S29_F3333_3", "L3_S33_F3865_9", "L0_S11_F302_7", 
             # "L1_S24_F1571_15", "L0_S11_F326_19", "L0_S21_F527_12", "L0_S9_F195_27", 
             # "L3_S41_F4016_4", "L2_S26_F3073_20", "L2_S27_F3214_18", "L1_S25_F2847_3", 
             # "L0_S6_F122_13", "L0_S11_F282_17", "L1_S24_F1814_9", "L0_S10_F244_10", 
             # "L0_S10_F259_11", "L0_S0_F18_13", "L0_S0_F14_9", "L0_S10_F244_5", 
             # "L0_S16_F426_17", "L0_S11_F314_10", "L0_S3_F72_9", "L0_S0_F12_13", 
             # "L3_S29_F3427_8", "L0_S7_F136_9", "L3_S30_F3689_10", "L3_S29_F3345_9", 
             # "L0_S12_F352_2", "L0_S9_F160_23", "L0_S11_F294_5", "L0_S19_F455_12", 
             # "L0_S9_F170_10", "L0_S12_F336_33", "L3_S49_F4211_2", "L0_S17_F433_4", 
             # "L0_S16_F421_-1", "L0_S12_F330_36", "L3_S30_F3749_21", "L0_S11_F314_33", 
             # "L0_S2_F64_15", "L0_S10_F259_16", "L1_S25_F2170_5", "L0_S8_F144_2", 
             # "L0_S21_F522_9", "L3_S33_F3857_10", "L0_S10_F224_3", "L1_S24_F1539", 
             # "L0_S7_F138_22", "L0_S22_F571_6", "L1_S24_F1544_5", "L1_S24_F1514_5", 
             # "L0_S23_F623_10", "L3_S30_F3754_14", "L1_S24_F1637_9", "L1_S24_F1728_4", 
             # "L2_S26_F3051_11", "L1_S24_F1812_17", "L0_S0_F4_25", "L0_S9_F180_10", 
             # "L0_S9_F170_19", "L0_S11_F314_46", "L0_S16_F426_39", "L1_S25_F2152_14", 
             # "L3_S33_F3855_14", "L0_S11_F310_3", "L2_S27_F3133_8", "L0_S0_F12_9", 
             # "L1_S24_F1778_7", "L3_S30_F3759_16", "L1_S24_F1685_14", "L2_S27_F3199_4", 
             # "L1_S24_F1793", "L0_S22_F561_17", "L3_S30_F3759_26", "L3_S30_F3829_10", 
             # "L1_S24_F1820_7", "L0_S23_F659_23", "L1_S24_F1502_3", "L0_S11_F310_20", 
             # "L1_S24_F1518_8", "L1_S24_F1743_6", "L0_S10_F259_28", "L0_S17_F431_-1", 
             # "L3_S29_F3339_29", "L0_S12_F330_37", "L3_S29_F3345_26", "L1_S24_F1808_19", 
             # "L1_S25_F1929", "L3_S36_F3918_4", "L0_S1_F28_15", "L1_S24_F1814_8", 
             # "L3_S30_F3669_9", "L2_S26_F3040_13", "L3_S29_F3479_13", "L0_S9_F180_2", 
             # "L0_S9_F210_3", "L3_S30_F3704_32", "L1_S24_F1798_3", "L3_S29_F3345_23", 
             # "L1_S25_F2164", "L0_S4_F104_7", "L1_S24_F1518_5", "L3_S30_F3604_3", 
             # "L0_S5_F116_4", "L0_S7_F138_17", "L0_S13_F354_38", "L0_S9_F160_19", 
             # "L0_S11_F318_26", "L3_S35_F3894_4", "L1_S24_F1773_12", "L3_S41_F4016_2", 
             # "L3_S38_F3960_10", "L0_S23_F623_8", "L0_S19_F459_7", "L0_S11_F318_25", 
             # "L0_S17_F433_19", "L3_S30_F3744_5", "L2_S27_F3199_17", "L0_S9_F195_34", 
             # "L0_S23_F643_8", "L0_S15_F406_13", "L1_S24_F1520_8", "L1_S25_F2091_4", 
             # "L0_S0_F10_14", "L0_S16_F426_44", "L0_S0_F4_6", "L2_S27_F3162_12", 
             # "L3_S30_F3504_3", "L1_S25_F2758", "L1_S25_F2770", "L0_S3_F80_6", 
             # "L3_S30_F3564_2", "L2_S26_F3051_23", "L2_S27_F3155_13", "L3_S30_F3684_9", 
             # "L0_S9_F190_9", "L3_S29_F3345_8", "L2_S27_F3133_20", "L3_S35_F3884", 
             # "L0_S0_F4_8", "L0_S11_F306_16", "L1_S24_F1148_7", "L0_S23_F627_13", 
             # "L1_S24_F1652_4", "L1_S24_F902_3", "L2_S27_F3133_16", "L1_S25_F1892_16", 
             # "L3_S33_F3865_6", "L3_S35_F3913", "L1_S24_F1783", "L2_S26_F3121_6", 
             # "L3_S36_F3918_12", "L3_S47_F4138_3", "L1_S24_F1356_3", "L2_S27_F3162_19", 
             # "L0_S10_F249_12", "L2_S27_F3133_10", "L0_S12_F330_23", "L3_S36_F3918_7", 
             # "L3_S48_F4196_2", "L0_S0_F14_37", "L0_S9_F160_9", "L0_S21_F522_11", 
             # "L0_S21_F482_5", "L1_S25_F2076", "L0_S11_F318_13", "L0_S11_F290_7", 
             # "L1_S24_F1753_4", "L0_S6_F122_9", "L0_S11_F310_11", "L1_S24_F1816_25", 
             # "L3_S30_F3709_7", "L3_S29_F3348_14", "L2_S26_F3121_8", "L1_S25_F2106_2", 
             # "L1_S24_F1012_2", "L3_S29_F3345_22", "L0_S0_F14_6", "L1_S24_F1575_29", 
             # "L3_S47_F4153_4", "L2_S26_F3073_4", "L0_S10_F259_2", "L0_S10_F259_39", 
             # "L2_S26_F3040_5", "L1_S24_F1838_20", "L0_S4_F104_-1", "L1_S24_F1728_15", 
             # "L0_S0_F10_3", "L2_S26_F3040_23", "L0_S10_F249_20", "L3_S41_F4000", 
             # "L0_S10_F224_26", "L0_S9_F195_32", "L0_S10_F254_4", "L0_S9_F160_24", 
             # "L0_S12_F340_9", "L1_S24_F1288", "L1_S24_F1743_5", "L0_S6_F132_8", 
             # "L0_S4_F109_19", "L0_S11_F294_14", "L3_S29_F3476_13", "L2_S26_F3069_3", 
             # "L0_S2_F32_9", "L0_S9_F205", "L0_S9_F190_13", "L0_S12_F334_7", 
             # "L2_S27_F3155_29", "L2_S26_F3036_28", "L3_S29_F3339_24", "L0_S10_F224_19", 
             # "L3_S44_F4115_9", "L1_S24_F1056_3", "L1_S24_F1518_4", "L0_S23_F663_8", 
             # "L0_S13_F354_10", "L3_S41_F4006_9", "L1_S24_F1575_31", "L0_S17_F431_23", 
             # "L1_S25_F2106_8", "L3_S30_F3829_18", "L0_S21_F532_3", "L1_S25_F2380_3", 
             # "L0_S12_F346_25", "L1_S24_F1808_6", "L0_S22_F606_8", "L2_S26_F3036_31", 
             # "L1_S24_F993_2", "L2_S26_F3040_9", "L1_S24_F1594_3", "L0_S15_F415_7", 
             # "L3_S49_F4211_8", "L1_S24_F1829_5", "L0_S9_F195_19", "L3_S41_F4014_20", 
             # "L1_S24_F1647_8", "L0_S11_F310_14", "L0_S21_F517_7", "L0_S21_F512_21", 
             # "L2_S27_F3166_20", "L0_S9_F195_31", "L0_S16_F421_17", "L0_S21_F502_7", 
             # "L3_S35_F3896_7", "L1_S24_F1571_30", "L3_S35_F3889_-1", "L0_S21_F522_3", 
             # "L3_S41_F4018_17", "L1_S24_F1571_11", "L0_S0_F8_11", "L1_S24_F1820_9", 
             # "L3_S47_F4138_4", "L2_S26_F3051_16", "L0_S23_F627_3", "L0_S23_F651_11", 
             # "L1_S24_F920_4", "L0_S11_F306_13", "L0_S0_F14_26", "L0_S13_F356_14", 
             # "L0_S4_F104_19", "L0_S0_F6_25", "L1_S24_F1657_3", "L0_S14_F370_4", 
             # "L0_S10_F224_16", "L0_S21_F472_6", "L0_S4_F109_28", "L1_S25_F2173_3", 
             # "L3_S41_F4020_13", "L3_S29_F3339_19", "L0_S10_F264_15", "L0_S21_F517_22", 
             # "L2_S27_F3166_13", "L0_S0_F4_20", "L0_S7_F138_14", "L0_S12_F336_10", 
             # "L1_S25_F2449_3", "L3_S29_F3479_9", "L3_S30_F3629_15", "L1_S24_F1514_2", 
             # "L1_S24_F963_11", "L0_S12_F336_32", "L3_S33_F3855_5", "L0_S21_F482_3", 
             # "L0_S9_F170_22", "L1_S24_F1293", "L3_S29_F3348_11", "L3_S30_F3749_13", 
             # "L1_S24_F1571_26", "L2_S26_F3040_26", "L1_S25_F2161_7", "L1_S25_F2173_2", 
             # "L0_S15_F418_12", "L0_S0_F18_10", "L1_S24_F1763_23", "L2_S26_F3051_3", 
             # "L2_S27_F3166_18", "L1_S25_F1968_6", "L0_S10_F224_32", "L3_S29_F3345_31", 
             # "L1_S24_F1376_7", "L1_S24_F1002_9", "L3_S29_F3357_5", "L3_S29_F3348_16", 
             # "L3_S30_F3609_7", "L1_S24_F1411", "L2_S26_F3062_23", "L0_S12_F332_22", 
             # "L1_S24_F802_13", "L0_S21_F477_7", "L0_S16_F426_14", "L0_S10_F249_18", 
             # "L0_S0_F6_8", "L1_S24_F1690_6", "L1_S24_F1172_10", "L1_S24_F1518_10", 
             # "L0_S10_F254_6", "L1_S24_F1728_39", "L1_S24_F829_2", "L3_S30_F3629_14", 
             # "L0_S22_F576_23", "L0_S0_F12_32", "L0_S9_F185_18", "L1_S24_F1850_8", 
             # "L0_S12_F348_9", "L3_S44_F4112_5", "L2_S27_F3155_14", "L1_S24_F1808_9", 
             # "L0_S11_F314_14", "L3_S30_F3679_6", "L0_S22_F551_28", "L1_S25_F2247_5", 
             # "L1_S24_F1844_2", "L1_S24_F1622_3", "L0_S13_F354_21", "L3_S29_F3348_27", 
             # "L0_S2_F32_17", "L0_S0_F10_16", "L2_S26_F3069_27", "L3_S30_F3634_4", 
             # "L1_S25_F2016_4", "L0_S11_F286_21", "L0_S16_F426_3", "L1_S25_F1894_14", 
             # "L0_S12_F348_28", "L0_S22_F596_29", "L1_S24_F1567_31", "L0_S22_F596_35", 
             # "L0_S4_F104_20", "L0_S17_F431_16", "L0_S12_F332_6", "L2_S28_F3303_7", 
             # "L0_S1_F24_12", "L1_S24_F1118_3", "L0_S22_F591_3", "L0_S16_F426_8", 
             # "L1_S24_F1812_13", "L1_S24_F1004_9", "L0_S9_F180_9", "L0_S0_F10_10", 
             # "L1_S25_F2026_2", "L1_S24_F1336_3", "L0_S10_F259_30", "L0_S11_F314_45", 
             # "L1_S24_F1482_5", "L1_S25_F2131_3", "L3_S35_F3898", "L0_S13_F356_10", 
             # "L1_S24_F1180_2", "L1_S24_F1006_6", "L3_S30_F3679_9", "L0_S11_F314_34", 
             # "L0_S4_F109_27", "L2_S26_F3051_18", "L0_S6_F118_-1", "L3_S29_F3342_6", 
             # "L3_S32_F3850_8", "L1_S24_F1778_6", "L0_S10_F234_13", "L0_S13_F356_6", 
             # "L1_S25_F2155_11", "L1_S25_F2007", "L1_S24_F1824_4", "L1_S24_F1773_14", 
             # "L2_S27_F3133_5", "L3_S30_F3704_14", "L1_S24_F1733_6", "L0_S0_F12_25", 
             # "L1_S25_F2021_4", "L0_S10_F234_23", "L0_S21_F522_5", "L0_S11_F314_4", 
             # "L1_S24_F1808_4", "L0_S22_F576_4", "L3_S36_F3920_7", "L0_S22_F561_7", 
             # "L0_S10_F264_16", "L0_S2_F40_17", "L3_S32_F3850_2", "L1_S25_F1938_6", 
             # "L1_S25_F2161_2", "L2_S27_F3129_11", "L0_S13_F356_5", "L0_S10_F224_7", 
             # "L1_S24_F1110_6", "L0_S11_F286_22", "L1_S24_F814_4", "L0_S4_F104_15", 
             # "L3_S29_F3327_14", "L0_S12_F344_12", "L0_S21_F502_12", "L0_S22_F591_13", 
             # "L0_S21_F502_3", "L0_S9_F155_10", "L2_S26_F3036_23", "L0_S12_F344_28", 
             # "L1_S24_F808_8", "L1_S24_F1094", "L0_S6_F122_14", "L2_S27_F3214_6", 
             # "L0_S8_F144_13", "L0_S10_F249_19", "L0_S0_F4_22", "L2_S26_F3062_16", 
             # "L1_S24_F1451_7", "L1_S25_F1943_2", "L0_S15_F397_7", "L3_S29_F3473_-1", 
             # "L2_S26_F3055", "L2_S26_F3040_3", "L1_S25_F2041", "L0_S14_F358_4", 
             # "L0_S3_F68_-1", "L1_S24_F1578_9", "L0_S9_F160_18", "L1_S24_F1512_2", 
             # "L1_S25_F2061_7", "L0_S23_F671_19", "L0_S12_F338_31", "L1_S24_F1130_9", 
             # "L0_S12_F340_37", "L1_S25_F2935_4", "L0_S6_F118_12", "L3_S29_F3342_15", 
             # "L1_S24_F1822_3", "L0_S12_F342_32", "L0_S1_F24_3", "L1_S25_F2051_2", 
             # "L0_S0_F14_29", "L0_S22_F561_10", "L1_S24_F1356_8", "L1_S25_F2155_8", 
             # "L0_S23_F631_6", "L3_S32_F3850_10", "L0_S22_F591_11", "L3_S44_F4118_13", 
             # "L1_S24_F812_13", "L0_S12_F334_24", "L0_S12_F332_23", "L0_S15_F394_10", 
             # "L1_S24_F1068", "L1_S24_F1778_8", "L0_S11_F318_18", "L2_S26_F3051_21", 
             # "L0_S22_F586_12", "L2_S26_F3036_10", "L0_S12_F330_8", "L0_S11_F282_8", 
             # "L1_S24_F1685_26", "L3_S36_F3918_-1", "L0_S0_F16_4", "L1_S24_F1575_25", 
             # "L1_S25_F2111_20", "L2_S27_F3199_7", "L1_S24_F1106_2", "L0_S12_F342_7", 
             # "L0_S0_F2_17", "L0_S7_F136_-1", "L3_S29_F3461_12", "L0_S12_F346_21", 
             # "L0_S12_F336_19", "L2_S28_F3259_3", "L1_S24_F1820_6", "L0_S11_F298_7", 
             # "L0_S10_F239_14", "L0_S3_F76_5", "L1_S25_F1963", "L2_S26_F3073_13", 
             # "L0_S11_F282_-1", "L0_S11_F326_27", "L1_S24_F1145_8", "L1_S24_F1820_4", 
             # "L1_S25_F1997", "L0_S4_F109_-1", "L1_S24_F1148_2", "L2_S27_F3155_32")

train_numeric <- DTcolsample(train_numeric, to_keep)
test_numeric <- DTcolsample(test_numeric, to_keep)
gc()

train <- readRDS("Laurae/jayjay_clean/train.rds")
test <- readRDS("Laurae/jayjay_clean/test.rds")
label <- readRDS("datasets/labels.rds")

train[, Id := NULL]
test[, Id := NULL]
gc()

to_keep <- which(colnames(train) %in% c("sameL0_Number1", "sameL1_Number1", "CATEGORICAL_Last_____1", 
                                        "GF1", "sameL3_Number1", "GF0", "sameL3", "BAC60_Sum_S3", "FOR60_Sum_S3", 
                                        "L1_S24_F1723", "DATE_S33max", "DATE_L3kurt", "FOR30_Sum_S", 
                                        "BAC30_Sum_S", "BAC100_Sum", "FOR100_Sum", "Kurtosis", "FOR165_log_lag", 
                                        "FOR100_log_lag_L3", "L1_S24_F1632", "BAC100_log_lag_L3", "L3_S33_F3857", 
                                        "FOR165_Sum", "L0max_L3max", "L0_Max", "L3_S30_F3754", "BAC100_log_lag", 
                                        "Range", "L3_S33_F3859", "FOR165_log_lag_L3", "L3max_L0min", 
                                        "L3_S30_F3744", "DATE_S32max", "S33max_S29min", "L3_L3_Unique_Count", 
                                        "L1_S24_F1844", "FOR100_log_lag", "L3_S30_F3759", "BAC165_log_lag", 
                                        "L3_S33_F3865", "BAC165_Sum", "BAC165_log_lag_L3", "L3_S30_F3749", 
                                        "CATEGORICAL_Last_____2", "Response_Minus1", "L3_S30_F3774", 
                                        "L3_S29_F3351", "L3_S30_F3809", "DATE_S34max", "L3_S30_F3804", 
                                        "L3_S30_F3704", "L3_S29_F3348", "L3_S29_F3345", "L3_S29_F3321", 
                                        "L3_S29_F3373", "L0_S1_F28", "L3_S29_F3324", "L3_S30_F3769", 
                                        "L3_S30_F3554", "L3_S29_F3427", "L0_S0_F20_Mult_L0_S0_F20", "L0_Mean", 
                                        "L3_S30_F3829", "L3_S30_F3494", "L3_S29_F3342", "L3_S29_F3354", 
                                        "S33min_S30min", "L1_S24_F1846", "sameL0", "L3_S36_F3920", "L3_S29_F3379", 
                                        "L0_Min", "Response_Minus1_Number1", "L3_S29_F3339", "L3_S29_F3315", 
                                        "L3_S29_F3333", "L3_S29_F3479", "L3_S29_F3327", "BAC60_log_lag_S34", 
                                        "L3_S30_F3609", "FOR60_log_lag_S34", "L3_S30_F3574", "L3_S30_F3794", 
                                        "L0_S1_F24", "L3_S30_F3534", "L3_S30_F3544", "L0_S9_F180", "L3_S29_F3336", 
                                        "L3_S29_F3382", "L3_S30_F3604", "L0_S0_F20", "L3_S29_F3376", 
                                        "L3_S30_F3784", "DATE_S35max", "L3_S29_F3330", "L0_S0_F18", "FOR165_log_lag_L2", 
                                        "L3_Max", "L2_Min", "L3_S30_F3514", "L3_S30_F3524", "L3_S30_F3819", 
                                        "L0_S0_F0", "L3_S30_F3519", "L0_S0_F16", "L3_S29_F3407", "BAC165_log_lag_L2", 
                                        "BAC165_log_lag_L1", "DATE_S30max", "L2max_S37max", "L3_S29_F3433", 
                                        "DATE_S37max", "L3_S29_F3318", "DATE_S36max", "L3_S30_F3639", 
                                        "L0_S4_F104", "L3_S30_F3709", "FOR30_log_lag_S34", "BAC165_log_lag_L0", 
                                        "L3_S30_F3764", "L3_S30_F3504", "BAC60_log_lag_S33", "L3_S30_F3629", 
                                        "L3_S30_F3509", "L3_S30_F3624", "L0_S10_F244", "L0_S0_F2", "L3_S29_F3473", 
                                        "L3max_S30max", "BAC165_LAG2_Missing_Value_Count_ResponseMinus1", 
                                        "BAC100_log_lag_L1", "L3_Range", "L0_S2_F36", "FOR165_log_lag_L1", 
                                        "L3_S29_F3436", "L0_S3_F100", "L3_S30_F3799", "L3_S29_F3430", 
                                        "BAC30_log_lag_S30", "L0_S5_F114", "S29min_S37min", "FOR165_log_lag_L0", 
                                        "L3_Min", "BAC100_LAG_Missing_Value_Count_ResponseMinus1", "CATEGORICAL_Unique_Count", 
                                        "L3_S30_F3579", "BAC30_log_lag_S33", "Min", "FOR165_LAG_Missing_Value_Count_ResponseMinus1", 
                                        "FOR60_log_lag_S33", "FOR165_LAG_Count_Mult_ResponseMinus1", 
                                        "L3_S29_F3461", "FOR165_LAG3_Count_Mult_ResponseMinus1", "S30min_S37min", 
                                        "FOR165_LAG3_Missing_Value_Count_ResponseMinus1", "L0_S11_F322", 
                                        "FOR100_LAG_Missing_Value_Count_ResponseMinus1", "FOR165_LAG1_Missing_Value_Count_ResponseMinus1", 
                                        "L0_S6_F132", "L0_S2_F44", "FOR100_LAG_Count_Mult_ResponseMinus1", 
                                        "BAC100_LAG3_Missing_Value_Count_ResponseMinus1", "BAC165_LAG_Missing_Value_Count_ResponseMinus1", 
                                        "CATEGORICAL_out_out_L3_S32_F3854_class2", "FOR60_log_lag_S30", 
                                        "BAC165_LAG2_Count_Mult_ResponseMinus1", "L0_S11_F310", "BAC165_LAG_Count_Mult_ResponseMinus1", 
                                        "BAC100_LAG_Count_Mult_ResponseMinus1", "L3_S30_F3669", "L0_S7_F138", 
                                        "BAC30_log_lag_S34", "L0_S2_F60", "L0_S5_F116", "FOR100_LAG2_Missing_Value_Count_ResponseMinus1", 
                                        "Mean", "FOR165_LAG2_Count_Mult_ResponseMinus1", "FOR165_LAG1_Count_Mult_ResponseMinus1", 
                                        "L3_S29_F3357", "FOR100_LAG3_Missing_Value_Count_ResponseMinus1", 
                                        "FOR165_LAG2_Missing_Value_Count_ResponseMinus1", "DATE_S6_max", 
                                        "FOR100_LAG0_Missing_Value_Count_ResponseMinus1", "FOR100_LAG2_Count_Mult_ResponseMinus1", 
                                        "FOR100_LAG1_Missing_Value_Count_ResponseMinus1", "BAC165_LAG0_Missing_Value_Count_ResponseMinus1", 
                                        "L0_Range", "FOR165_LAG0_Missing_Value_Count_ResponseMinus1", 
                                        "FOR100_log_lag_L2", "BAC165_LAG1_Missing_Value_Count_ResponseMinus1", 
                                        "L3_S35_F3896", "BAC165_LAG1_Count_Mult_ResponseMinus1", "L0_S2_F64", 
                                        "L0_S3_F72", "CATEGORICAL_Missing_Value_Count", "Unique_Count", 
                                        "L0_S0_F8", "DATE_S0_max", "L0_S3_F96", "L0_S4_F109", "L3_S30_F3589", 
                                        "L1_Min", "BAC100_log_lag_L2", "BAC165_LAG3_Missing_Value_Count_ResponseMinus1", 
                                        "BAC100_LAG2_Missing_Value_Count_ResponseMinus1", "DATE_L1kurt", 
                                        "FOR100_LAG3_Count_Mult_ResponseMinus1", "L3_S30_F3684", "L3_S35_F3889", 
                                        "L2_S26_F3106", "FOR100_log_lag_L1", "S36max_S29min", "FOR165_LAG0_Count_Mult_ResponseMinus1", 
                                        "DATE_S5_max", "BAC100_LAG1_Missing_Value_Count_ResponseMinus1", 
                                        "BAC100_LAG0_Count_Mult_ResponseMinus1", "L3_S29_F3476", "L3_S30_F3644", 
                                        "BAC100_LAG3_Count_Mult_ResponseMinus1", "L0_S6_F122", "BAC100_LAG0_Missing_Value_Count_ResponseMinus1", 
                                        "BAC165_LAG0_Count_Mult_ResponseMinus1", "BAC165_LAG3_Count_Mult_ResponseMinus1", 
                                        "L0_S3_F80", "L2_S26_F3062", "L0_S10_F254", "DATE_S7_max", "L0_S0_F6", 
                                        "FOR30_log_lag_S30", "L0_S0_F4", "FOR30_log_lag_S33", "L0_S7_F142", 
                                        "L0_S11_F326", "FOR100_LAG1_Count_Mult_ResponseMinus1", "L0_S0_F22", 
                                        "S33min_S37min", "S29min_S34min", "BAC100_LAG2_Count_Mult_ResponseMinus1", 
                                        "BAC100_log_lag_L0", "BAC60_log_lag_S30", "BAC100_LAG1_Count_Mult_ResponseMinus1", 
                                        "L0_S11_F302", "L3_S30_F3569", "L0_S10_F259", "L3_S30_F3674", 
                                        "DATE_S24max", "FOR100_log_lag_L0", "L1_Max", "L0_S21_F497", 
                                        "DATE_S3_max", "FOR100_LAG0_Count_Mult_ResponseMinus1", "L0_S9_F170", 
                                        "L0_S0_F10", "DATE_S29max", "L0_S9_F165", "L0_S9_F185", "L2_S26_F3069", 
                                        "DATE_S2_max", "L0_S0_F14", "L0_S9_F155", "S29min_S32min", "L2_S27_F3129", 
                                        "DATE_S4_max", "L0_S13_F354", "L1_S24_F1578", "L3_S30_F3689", 
                                        "L3_S30_F3584", "L3_S30_F3564", "L3_S30_F3664", "DATE_S38max", 
                                        "L1_Range", "S37min_S34min", "L3max_S34min", "L0_S9_F160", "L0_S10_F229", 
                                        "L0_S9_F190", "L0_S11_F294", "L0_S11_F290", "L0_S12_F332", "L0_S10_F224", 
                                        "L0_S11_F286", "DATE_S8_max", "S29max_S35max", "L0_S11_F318", 
                                        "L3_S30_F3634", "sameL2", "L1_S24_F1850", "L0_S12_F348", "L2_S26_F3117", 
                                        "L0_S11_F306", "L0_S10_F249", "L0_S13_F356", "L0_S23_F643", "DATE_S24min", 
                                        "L0_S10_F219", "S30min_S35min", "L0_S9_F195", "L2_S27_F3210", 
                                        "L1_S24_F1516", "L3_S30_F3679", "L0_S12_F350", "S13min_S33min", 
                                        "L0_S11_F282", "L0_S12_F330", "L0_S0_F12", "L2_S26_F3036", "DATE_S10max", 
                                        "L0_S11_F314", "L0_Unique_Count", "L3_S29_F3360", "L3_Unique_Count", 
                                        "L0_S12_F346", "L3_S32_F3850", "L0_S8_F144", "L3max_S26max", 
                                        "DATE_S26max", "DATE_S1_max", "L0_S11_F314_Mult_L0_S0_F20", "L3_S35_F3894", 
                                        "L0_S18_F439", "L2_S26_F3073", "L0_S23_F667", "L2_S26_F3113", 
                                        "L2_S26_F3040", "S35min_L1min", "L0_S10_F234", "L0_S11_F314_Mult_L0_S11_F314", 
                                        "L2_S26_F3121", "L1_S24_F1758", "L2_S27_F3162", "sameL1", "L0_S3_F84", 
                                        "S33min_S36min", "L1_S24_F1667", "DATE_S18max", "L2_S27_F3199", 
                                        "L3_S33_F3855", "L1_S24_F1494", "DATE_S16max", "L2_S26_F3047", 
                                        "L0_S2_F48", "L2_Max", "L3_S38_F3960", "DATE_S13max", "L2_S27_F3133", 
                                        "L0_S9_F200", "L3_L3_Missing_Value_Count", "L2_S27_F3155", "DATE_S11max", 
                                        "DATE_S9_max", "L3_S41_F4008", "L0_S10_F239", "S33min_S35min", 
                                        "L0_S23_F639", "L0_S17_F433", "S26max_S32max", "L0_S16_F426", 
                                        "L0_S10_F264", "L2_S27_F3214", "L1_S24_F1672", "S34min_S35min", 
                                        "L0_S14_F386", "L0_S21_F532", "L2_S27_F3206", "L1_S24_F1831", 
                                        "L0_S14_F370", "L2_S26_F3051", "L1_S24_F1514", "L1_S24_F1463", 
                                        "L1_S24_F1773", "L3_S41_F4011", "DATE_S14max", "L3_S36_F3918", 
                                        "L1_S24_F1581", "DATE_S27max", "L1_S24_F1662", "FOR165_LAG3_Sum_ResponseMinus1", 
                                        "DATE_S19max", "L0_S14_F362", "L0_S14_F390", "L0_S22_F576", "L0_S15_F415", 
                                        "CATEGORICAL_Max______3", "L1_S24_F1520", "L0_S23_F671", "L0_S19_F455", 
                                        "L1_S24_F1783", "L2_S27_F3144", "L1_S24_F1842", "L1_S24_F1788", 
                                        "L0_S22_F606", "L0_S21_F482", "L1_S24_F1544", "L0_S22_F591", 
                                        "L0_S9_F210", "S26min_S24min", "L3_S29_F3482", "L1_S24_F1565", 
                                        "S27min_S32min", "L1_S24_F1518", "L0_S16_F421", "L1_S25_F2161", 
                                        "L0_S15_F418", "L0_S12_F336", "L0_S22_F571", "L3_S48_F4198", 
                                        "L0_S12_F344", "DATE_S22max", "L1_S25_F2116", "DATE_S15max", 
                                        "L1_S24_F1824", "L0_S12_F342", "L0_S12_F334", "L2_S27_F3140", 
                                        "L3_S47_F4163", "DATE_S17max", "L0_S21_F502", "L0_S15_F403", 
                                        "S33min_S34min", "L2_S27_F3166", "L1_S24_F1637", "L1_S24_F1763", 
                                        "L0_S10_F274", "L3_S45_F4124", "L1_S24_F1700", "L0_S19_F459", 
                                        "L0_S14_F374", "L1_S24_F1573", "L0_S21_F492", "L3_S41_F4004", 
                                        "L1_S24_F1778", "L0_S15_F397", "L0_S21_F522", "L0_S12_F338", 
                                        "L3_S41_F4026", "S26min_S37min", "L0_S17_F431", "L0_S15_F406", 
                                        "L0_S18_F449", "L0_S23_F619", "DATE_S21max", "L1_S24_F1575", 
                                        "L1_S24_F1685", "L3_S47_F4153", "L1_S24_F1498", "L0_S23_F659", 
                                        "L0_S12_F352", "L0_S9_F175", "DATE_S23max", "L0_S23_F651", "L1_S24_F1571", 
                                        "L0_S2_F56", "L1_S24_F1652", "L1_S24_F1848", "L0_S22_F556", "L1_S25_F1958", 
                                        "L0_S21_F507", "L0_S2_F32", "DATE_S20max", "L0_S12_F340", "L3_S41_F4020", 
                                        "L1_Unique_Count", "L0_S3_F76", "L0_S23_F655", "L0_S21_F487", 
                                        "L1_S25_F2176", "L1_L1_Missing_Value_Count", "L0_S21_F517", "L0_S22_F586", 
                                        "L1_S24_F1829", "L1_S24_F1567", "DATE_S25max", "L3_S48_F4196", 
                                        "L0_S21_F477", "L1_S24_F1798", "L0_S23_F631", "L0_S22_F601", 
                                        "L3_S41_F4006", "L3_S43_F4090", "L0_S21_F472", "L0_S23_F623", 
                                        "L1_S24_F1599", "L0_S3_F68", "L3_S41_F4014", "L3_S40_F3986", 
                                        "L1_S25_F2136", "L3_S40_F3984", "L0_S21_F527", "L1_S24_F1808", 
                                        "L3_S47_F4158", "L1_S24_F1539", "L0_S21_F537", "L0_S22_F551", 
                                        "BAC100_LAG3_Sum_ResponseMinus1", "DATE_S12max", "L1_S24_F1728", 
                                        "L1_S25_F2158", "L1_S24_F1738", "L3_S38_F3956", "L1_S24_F1512", 
                                        "L0_S21_F512", "L0_S23_F663", "DATE_S44max", "BAC100_LAG_Sum_ResponseMinus1", 
                                        "L1_S24_F1753", "L3_S47_F4138", "L3_S40_F3982", "L1_S24_F1609", 
                                        "BAC165_LAG3_Sum_ResponseMinus1", "L0_S15_F400", "DATE_S40max", 
                                        "L0_S22_F596", "L1_S24_F1713", "DATE_S25min", "L0_S20_F461", 
                                        "DATE_S48max", "L3_S44_F4115", "L1_S24_F1122", "L1_S24_F1814", 
                                        "L0_S7_F136", "L0_S6_F118", "L1_S24_F1822", "L1_S24_F1803", "L1_S25_F2101", 
                                        "BAC100_LAG1_Sum_ResponseMinus1", "FOR165_LAG0_Sum_ResponseMinus1", 
                                        "L3_S41_F4000", "L1_S24_F829", "L3_S49_F4211", "L3_S44_F4112", 
                                        "L1_S24_F1816", "L3_S47_F4143", "FOR100_LAG2_Sum_ResponseMinus1", 
                                        "L1_S24_F1743", "CATEGORICAL_out_L3_S32_F3854_class1", "FOR100_LAG_Sum_ResponseMinus1", 
                                        "S32max_S37min", "L0_S2_F40", "L0_S23_F627", "FOR165_LAG_Sum_ResponseMinus1", 
                                        "L1_S24_F1647", "BAC165_LAG1_Sum_ResponseMinus1", "L1_S24_F1812", 
                                        "L1_S24_F1627", "L0_S3_F92", "L1_S24_F1718", "L0_S22_F546", "BAC165_LAG_Sum_ResponseMinus1", 
                                        "L3_S41_F4016", "L1_S25_F2106", "L1_S24_F1748", "L1_S25_F1973", 
                                        "FOR100_LAG3_Sum_ResponseMinus1", "L1_S25_F1938", "L3_S30_F3649", 
                                        "L3_S36_F3938", "L1_S25_F2131", "L1_S25_F2111", "L1_S24_F1733", 
                                        "L0_S14_F366", "L1_S25_F2147", "DATE_S41max", "L1_S25_F2126", 
                                        "L1_S25_F1892", "L1_S25_F2170", "L1_S24_F1622", "L2_L2_Unique_Count", 
                                        "L1_S25_F1855", "L1_S24_F1690", "L3_S41_F4023", "sameL2_Number1", 
                                        "L1_S24_F983", "DATE_S47max", "FOR100_LAG1_Sum_ResponseMinus1", 
                                        "L1_S24_F1490", "DATE_S45min", "DATE_S50max", "L3_S43_F4085", 
                                        "L1_S25_F2056", "L3_S38_F3952", "L1_S25_F1869", "L3_S43_F4080", 
                                        "DATE_S39max", "BAC165_LAG2_Sum_ResponseMinus1", "L1_S24_F1506", 
                                        "L1_S25_F1968", "DATE_S43max", "L3_S44_F4118", "L1_S25_F2091", 
                                        "L1_S25_F1900", "L1_S24_F1642", "L1_S25_F2155", "S32min_S10min", 
                                        "L3_S40_F3980", "L1_S25_F2051", "S32min_S30min", "L1_S24_F948", 
                                        "L1_S25_F1992", "L1_S24_F1818", "S32max_S25min", "DATE_S28max", 
                                        "L0_S10_F269", "L1_S24_F1838", "BAC165_LAG0_Sum_ResponseMinus1", 
                                        "L3_S29_F3488", "L1_S25_F1909", "BAC100_LAG0_Sum_ResponseMinus1", 
                                        "DATE_S51max", "L1_S24_F1836", "BAC100_LAG2_Sum_ResponseMinus1", 
                                        "Max", "FOR100_LAG0_Sum_ResponseMinus1", "L1_S24_F1820", "FOR165_LAG2_Sum_ResponseMinus1", 
                                        "L1_S25_F2173", "L1_S24_F1768", "L1_S25_F2016", "L3_S50_F4243", 
                                        "L2_S26_F3125", "L1_S25_F2061", "L1_S24_F1166", "L1_S25_F2797", 
                                        "L1_S24_F810", "L1_S25_F1858", "L1_S25_F2167", "L1_S25_F2152", 
                                        "L1_S24_F1657", "L1_S24_F1793", "L1_S24_F1041", "L1_S24_F1594", 
                                        "L3_S43_F4095", "L1_S25_F2144", "L1_S24_F1834", "L3_S44_F4121", 
                                        "L1_S25_F1978", "DATE_S49max", "FOR165_LAG1_Sum_ResponseMinus1", 
                                        "L1_S24_F1202", "L0_S22_F611", "L1_S24_F1006", "S25max_S32min", 
                                        "L1_S24_F1180", "L1_S25_F1919", "L1_S24_F988", "L1_S24_F1336", 
                                        "L1_S24_F1391", "L1_S24_F1240", "L0_S9_F205", "L1_S24_F1810", 
                                        "L1_S25_F2071", "L1_S25_F2164", "L1_S25_F2086", "L1_S24_F958", 
                                        "L1_S24_F733", "DATE_S31max", "L1_S24_F1056", "L1_S25_F1953", 
                                        "L3_S30_F3499", "L3_S47_F4148", "L1_S25_F2031", "L1_S24_F814", 
                                        "L0_S22_F561", "L1_S24_F1366", "L1_S24_F963", "CATEGORICAL_Max______1", 
                                        "L1_S24_F1002", "L3_S31_F3842", "L1_S24_F1303", "L2_S28_F3307", 
                                        "L2_S26_F3077", "L1_S24_F1356", "L3_S34_F3882", "L3_S30_F3734", 
                                        "L1_S24_F683", "L1_S24_F1482", "L1_S24_F1000", "L1_S24_F1197", 
                                        "L1_S25_F1877", "L1_S24_F1245", "L1_S24_F1321", "L1_S24_F1331", 
                                        "L1_S24_F1172", "L1_S25_F2041", "L1_S24_F700", "L1_S25_F2007", 
                                        "L2_S28_F3248", "L1_S24_F1293", "L1_S25_F1963", "L1_S24_F691", 
                                        "L1_S25_F2837", "L1_S25_F2081", "L3_S37_F3950"))

train <- DTcolsample(train, to_keep)
test <- DTcolsample(test, to_keep)
gc()

train <- DTcbind(train, train_numeric, low_mem = TRUE, collect = 50, silent = FALSE)
test <- DTcbind(test, test_numeric, low_mem = TRUE, collect = 50, silent = FALSE)
rm(train_numeric, test_numeric)
gc()

StratifiedCV <- function(Y, folds, seed) {
  folded <- list()
  folded1 <- list()
  folded2 <- list()
  set.seed(seed)
  temp_Y0 <- which(Y == 0)
  temp_Y1 <- which(Y == 1)
  for (i in 1:folds) {
    folded1[[i]] <- sample(temp_Y0, floor(length(temp_Y0) / ((folds + 1) - i)))
    temp_Y0 <- temp_Y0[!temp_Y0 %in% folded1[[i]]]
    folded2[[i]] <- sample(temp_Y1, floor(length(temp_Y1) / ((folds + 1) - i)))
    temp_Y1 <- temp_Y1[!temp_Y1 %in% folded2[[i]]]
    folded[[i]] <- c(folded1[[i]], folded2[[i]])
  }
  return(folded)
}

folds <- StratifiedCV(label, 5, 11111)


# Real cannon is here

temp_model <- lgbm.cv(y_train = label,
                      x_train = train,
                      x_test = test,
                      data_has_label = TRUE,
                      NA_value = "nan",
                      lgbm_path = my_lgbm_is_at,
                      workingdir = my_script_is_using,
                      files_exist = FALSE,
                      save_binary = FALSE,
                      validation = TRUE,
                      folds = folds,
                      predictions = TRUE,
                      importance = TRUE,
                      full_quiet = FALSE,
                      verbose = FALSE,
                      num_threads = threads,
                      application = "binary",
                      learning_rate = eta,
                      num_iterations = 500,
                      early_stopping_rounds = 75,
                      num_leaves = leaves,
                      min_data_in_leaf = min_sample,
                      min_sum_hessian_in_leaf = min_hess,
                      max_bin = 255,
                      feature_fraction = colsample,
                      bagging_fraction = subsample,
                      bagging_freq = sampling_freq,
                      is_unbalance = FALSE,
                      metric = "auc",
                      is_training_metric = TRUE)

saveRDS(temp_model, file.path(my_script_is_using, "aaa_LightGBM_cv.rds"), compress = TRUE)

gc()

#temp_model <- readRDS(file.path(my_script_is_using, "aaa_LightGBM_cv.rds"))

best_iter <- 0
for (j in 1:5) {
  best_iter <- best_iter + 0.2 * temp_model$Models[[j]]$Best
}

best_model <- lgbm.train(y_train = label,
                         x_train = train,
                         x_test = test,
                         data_has_label = TRUE,
                         NA_value = "nan",
                         lgbm_path = my_lgbm_is_at,
                         workingdir = my_script_is_using,
                         files_exist = FALSE,
                         save_binary = FALSE,
                         predictions = TRUE,
                         importance = TRUE,
                         full_quiet = FALSE,
                         verbose = TRUE,
                         num_threads = threads,
                         application = "binary",
                         learning_rate = eta,
                         num_iterations = floor(best_iter * 1.1),
                         num_leaves = leaves,
                         min_data_in_leaf = min_sample,
                         min_sum_hessian_in_leaf = min_hess,
                         max_bin = 255,
                         feature_fraction = colsample,
                         bagging_fraction = subsample,
                         bagging_freq = sampling_freq,
                         is_unbalance = FALSE,
                         metric = "auc",
                         is_training_metric = TRUE)

saveRDS(best_model, file.path(my_script_is_using, "aaa_LightGBM_full.rds"), compress = TRUE)



mcc_fixed <- function(y_prob, y_true, prob) {
  
  positives <- as.logical(y_true) # label to boolean
  counter <- sum(positives) # get the amount of positive labels
  tp <- as.numeric(sum(y_prob[positives] > prob))
  fp <- as.numeric(sum(y_prob[!positives] > prob))
  tn <- as.numeric(length(y_true) - counter - fp) # avoid computing he opposite
  fn <- as.numeric(counter - tp) # avoid computing the opposite
  mcc <- (tp * tn - fp * fn) / (sqrt((tp + fp) * (tp + fn) * (tn + fp) * (tn + fn)))
  mcc <- ifelse(is.na(mcc), -1, mcc)
  return(mcc)
  
}

mcc_eval_print <- function(y_prob, y_true) {
  y_true <- y_true
  
  DT <- data.table(y_true = y_true, y_prob = y_prob, key = "y_prob")
  
  nump <- sum(y_true)
  numn <- length(y_true) - nump
  
  DT[, tn_v := as.numeric(cumsum(y_true == 0))]
  DT[, fp_v := cumsum(y_true == 1)]
  DT[, fn_v := numn - tn_v]
  DT[, tp_v := nump - fp_v]
  DT[, tp_v := nump - fp_v]
  DT[, mcc_v := (tp_v * tn_v - fp_v * fn_v) / sqrt((tp_v + fp_v) * (tp_v + fn_v) * (tn_v + fp_v) * (tn_v + fn_v))]
  DT[, mcc_v := ifelse(!is.finite(mcc_v), 0, mcc_v)]
  gc(verbose = FALSE)
  
  return(max(DT[['mcc_v']]))
  
}

mcc_eval_pred <- function(y_prob, y_true) {
  y_true <- y_true
  
  DT <- data.table(y_true = y_true, y_prob = y_prob, key = "y_prob")
  
  nump <- sum(y_true)
  numn <- length(y_true) - nump
  
  DT[, tn_v := as.numeric(cumsum(y_true == 0))]
  DT[, fp_v := cumsum(y_true == 1)]
  DT[, fn_v := numn - tn_v]
  DT[, tp_v := nump - fp_v]
  DT[, tp_v := nump - fp_v]
  DT[, mcc_v := (tp_v * tn_v - fp_v * fn_v) / sqrt((tp_v + fp_v) * (tp_v + fn_v) * (tn_v + fp_v) * (tn_v + fn_v))]
  DT[, mcc_v := ifelse(!is.finite(mcc_v), 0, mcc_v)]
  
  return(DT[['y_prob']][which.max(DT[['mcc_v']])])
  
}

FastROC <- function(y, x) {
  
  # y = actual
  # x = predicted
  x1 = as.numeric(x[y == 1])
  n1 = as.numeric(length(x1))
  x2 = as.numeric(x[y == 0])
  n2 = as.numeric(length(x2))
  r = rank(c(x1,x2))
  return((sum(r[1:n1]) - n1 * (n1 + 1) / 2) / (n1 * n2))
  
}




# Know what is inside


AnalysisFunc <- function(lgbm, label, folds, validationValues, predictedValuesCV, predictedValues) {
  # lgbm = your LightGBM cross-validated model (set as "NA" if it is not a LGBM model)
  # Label = your label
  # Folds = your fold list
  # validationValues = your validation values (out of fold predictions)
  # predictedValuesCV = your predicted values (on test data) from CV (set as "NA" if you don't have any)
  # predictedValues = your prediction values (on test data) on a model trained on all data (set as "NA" if you don't have any)
  
  if (length(lgbm) > 1) {
    
    # Print feature importance to file
    
    jpeg(filename = file.path(my_script_is_using, "importance_log_small.jpg"), width = 760, height = 894, units = "px", pointsize = 12)
    lgbm.fi.plot(temp_model, n_best = 50, no_log = FALSE, is.cv = TRUE, multipresence = TRUE, plot = TRUE)
    dev.off()
    jpeg(filename = file.path(my_script_is_using, "importance_nonlog_small.jpg"), width = 760, height = 894, units = "px", pointsize = 12)
    lgbm.fi.plot(temp_model, n_best = 50, no_log = TRUE, is.cv = TRUE, multipresence = TRUE, plot = TRUE)
    dev.off()
    
    jpeg(filename = file.path(my_script_is_using, "importance_log_big.jpg"), width = 760, height = 1788, units = "px", pointsize = 12)
    lgbm.fi.plot(temp_model, n_best = 100, no_log = FALSE, is.cv = TRUE, multipresence = TRUE, plot = TRUE)
    dev.off()
    jpeg(filename = file.path(my_script_is_using, "importance_nonlog_big.jpg"), width = 760, height = 1788, units = "px", pointsize = 12)
    lgbm.fi.plot(temp_model, n_best = 100, no_log = TRUE, is.cv = TRUE, multipresence = TRUE, plot = TRUE)
    dev.off()
    
  }
  
  # Setup tee
  sink(file = file.path(my_script_is_using, "diagnostics.txt"), append = FALSE, split = TRUE)
  cat("```r\n")
  
  if (length(lgbm) > 1) {
    
    # Get iteration information
    temp_iter <- numeric(5)
    best_iter <- 0
    for (j in 1:5) {
      temp_iter[j] <- lgbm$Models[[j]]$Best
      best_iter <- best_iter + (temp_iter[j] / length(folds))
      cat("Fold ", j, " converged after ", temp_iter[j], " iterations.\n", sep = "")
    }
    cat("Iterations: ", mean(temp_iter), " + ", sd(temp_iter), "\n\n\n", sep = "")
    
  }
  
  # Get AUC metric information
  temp_auc <- numeric(length(folds))
  best_auc <- 0
  for (j in 1:length(folds)) {
    temp_auc[j] <- FastROC(y = label[folds[[j]]], x = validationValues[folds[[j]]])
    best_auc <- best_auc + (temp_auc[j] / length(folds))
    cat("Fold ", j, ": AUC=", temp_auc[j], "\n", sep = "")
  }
  cat("AUC: ", mean(temp_auc), " + ", sd(temp_auc), "\n", sep = "")
  cat("Average AUC using all data: ", FastROC(y = label, x = validationValues), "\n\n\n", sep = "")
  
  
  # Get MCC metric information
  temp_mcc <- numeric(length(folds))
  temp_thresh <- numeric(length(folds))
  temp_positives <- numeric(length(folds))
  temp_detection <- numeric(length(folds))
  best_mcc <- 0
  for (j in 1:length(folds)) {
    
    temp_mcc[j] <- mcc_eval_print(y_prob = validationValues[folds[[j]]], y_true = label[folds[[j]]])
    temp_thresh[j] <- mcc_eval_pred(y_prob = validationValues[folds[[j]]], y_true = label[folds[[j]]])
    temp_positives[j] <- sum(validationValues[folds[[j]]] > temp_thresh[[j]])
    temp_detection[j] <- temp_positives[j] / sum(label[folds[[j]]])
    best_mcc <- best_mcc + (temp_mcc[j] / length(folds))
    cat("Fold ", j, ": MCC=", temp_mcc[j], " (", temp_positives[j], " [", sprintf("%05.2f", temp_detection[j] * 100), "%] positives), threshold=", temp_thresh[j], "\n", sep = "")
    
  }
  cat("MCC: ", mean(temp_mcc), " + ", sd(temp_mcc), "\n", sep = "")
  cat("Positives: ", mean(temp_positives), " + ", sd(temp_positives), "\n", sep = "")
  cat("Detection Rate: ", mean(temp_detection), " + ", sd(temp_detection), "\n", sep = "")
  cat("Average MCC on all data (5 fold): ", mcc_fixed(y_prob = validationValues, y_true = label, prob = mean(temp_mcc)), ", threshold=", mean(temp_mcc), "\n", sep = "")
  cat("Average MCC using all data: ", mcc_eval_print(y_prob = validationValues, y_true = label), ", threshold=", mcc_eval_pred(y_prob = validationValues, y_true = label), "\n\n\n", sep = "")
  
  
  if (length(predictedValuesCV) > 1) {
    
    # Create overfitted submission from all data
    best_mcc1 <- mcc_eval_pred(y_prob = validationValues, y_true = label)
    submission0_ov <- fread("datasets/sample_submission.csv", header = TRUE, sep = ",", stringsAsFactors = FALSE)
    submission0_ov$Response <- as.numeric(predictedValuesCV > best_mcc1)
    best_count1 <- sum(submission0_ov$Response == 1)
    cat("Submission overfitted threshold on all MCC positives: ", best_count1, "\n\n", sep = "")
    write.csv(submission0_ov, file = file.path(my_script_is_using, paste(my_script_subbed, "_val_", sprintf("%.06f", best_mcc1), "_", best_count1, ".csv", sep = "")), row.names = FALSE)
    
    # Create CV submission from validation
    best_mcc2 <- best_mcc
    submission0 <- fread("datasets/sample_submission.csv", header = TRUE, sep = ",", stringsAsFactors = FALSE)
    submission0$Response <- as.numeric(predictedValuesCV > best_mcc2)
    best_count2 <- sum(submission0$Response == 1)
    cat("Submission average validated threshold on all MCC positives: ", best_count2, "\n\n", sep = "")
    write.csv(submission0, file = file.path(my_script_is_using, paste(my_script_subbed, "_val_", sprintf("%.06f", best_mcc2), "_", best_count2, ".csv", sep = "")), row.names = FALSE)
    
    # Create average of the two previous submissions
    best_mcc3 <- (best_mcc1 + best_mcc2) / 2
    submission0_ex <- fread("datasets/sample_submission.csv", header = TRUE, sep = ",", stringsAsFactors = FALSE)
    submission0_ex$Response <- as.numeric(predictedValuesCV > best_mcc3)
    best_count3 <- sum(submission0_ex$Response == 1)
    cat("Submission average of overfit+validated threshold positives: ", best_count3, "\n\n", sep = "")
    write.csv(submission0_ex, file = file.path(my_script_is_using, paste(my_script_subbed, "_val_", sprintf("%.06f", best_mcc3), "_", best_count3, ".csv", sep = "")), row.names = FALSE)
    
    # Create files for stacker
    write.csv(validationValues, file = file.path(my_script_is_using, "aaa_stacker_preds_train_headerY.csv"), row.names = FALSE)
    write.csv(predictedValuesCV, file = file.path(my_script_is_using, "aaa_stacker_preds_test_headerY.csv"), row.names = FALSE)
    
  }
  
  
  if (length(predictedValues) > 1) {
    
    # Create overfitted submission from all data using full trained model
    best_mcc1_all <- best_mcc1
    submission0_ov_all <- fread("datasets/sample_submission.csv", header = TRUE, sep = ",", stringsAsFactors = FALSE)
    submission0_ov_all$Response <- as.numeric(predictedValues > best_mcc1_all)
    best_count1_all <- sum(submission0_ov_all$Response == 1)
    cat("Submission with all data overfitted threshold on all MCC positives: ", best_count1_all, ". Threshold=", best_mcc1_all, "\n\n", sep = "")
    write.csv(submission0_ov_all, file = file.path(my_script_is_using, paste(my_script_subbed, "_all_", sprintf("%.06f", best_mcc1_all), "_", best_count1_all, ".csv", sep = "")), row.names = FALSE)
    
    # Create CV submission from validation using full trained model
    best_mcc2_all <- best_mcc2
    submission0_all <- fread("datasets/sample_submission.csv", header = TRUE, sep = ",", stringsAsFactors = FALSE)
    submission0_all$Response <- as.numeric(predictedValues > best_mcc2_all)
    best_count2_all <- sum(submission0_all$Response == 1)
    cat("Submission with all data average validated threshold on all MCC positives: ", best_count2_all, ". Threshold=", best_mcc2_all, "\n\n", sep = "")
    write.csv(submission0_all, file = file.path(my_script_is_using, paste(my_script_subbed, "_all_", sprintf("%.06f", best_mcc2_all), "_", best_count2_all, ".csv", sep = "")), row.names = FALSE)
    
    # Create average of the two previous submissions using full trained model
    best_mcc3_all <- best_mcc3
    submission0_ex_all <- fread("datasets/sample_submission.csv", header = TRUE, sep = ",", stringsAsFactors = FALSE)
    submission0_ex_all$Response <- as.numeric(predictedValues > best_mcc3_all)
    best_count3_all <- sum(submission0_ex_all$Response == 1)
    cat("Submission with all data average of overfit+validated threshold positives: ", best_count3_all, ". Threshold=", best_mcc3_all, "\n\n", sep = "")
    write.csv(submission0_ex_all, file = file.path(my_script_is_using, paste(my_script_subbed, "_all_", sprintf("%.06f", best_mcc3_all), "_", best_count3_all, ".csv", sep = "")), row.names = FALSE)
    
    
    
    mini_preds <- predictedValues
    mini_preds <- mini_preds[order(mini_preds, decreasing = TRUE)]
    
    # Create overfitted submission from all data using full trained model using respective positive count
    best_mcc1_all_val <- mini_preds[best_count1 + 1]
    submission0_ov_all_val <- fread("datasets/sample_submission.csv", header = TRUE, sep = ",", stringsAsFactors = FALSE)
    submission0_ov_all_val$Response <- as.numeric(predictedValues > best_mcc1_all_val)
    best_count1_all_val <- sum(submission0_ov_all_val$Response == 1)
    cat("Submission with all data by taking the amount of positives of overfitted threshold on all MCC positives: ", best_count1_all_val, ". Threshold=", best_mcc1_all_val, "\n\n", sep = "")
    write.csv(submission0_ov_all_val, file = file.path(my_script_is_using, paste(my_script_subbed, "_all_val_", sprintf("%.06f", best_mcc1_all_val), "_", best_count1_all_val, ".csv", sep = "")), row.names = FALSE)
    
    # Create CV submission from validation using full trained model using respective positive count
    best_mcc2_all_val <- mini_preds[best_count2 + 1]
    submission0_all_val <- fread("datasets/sample_submission.csv", header = TRUE, sep = ",", stringsAsFactors = FALSE)
    submission0_all_val$Response <- as.numeric(predictedValues > best_mcc2_all_val)
    best_count2_all_val <- sum(submission0_all_val$Response == 1)
    cat("Submission with all data by taking the amount of positives of average validated threshold on all MCC positives: ", best_count2_all_val, ". Threshold=", best_mcc2_all_val, "\n\n", sep = "")
    write.csv(submission0_all_val, file = file.path(my_script_is_using, paste(my_script_subbed, "_all_val_", sprintf("%.06f", best_mcc2_all_val), "_", best_count2_all_val, ".csv", sep = "")), row.names = FALSE)
    
    # Create average of the two previous submissions using full trained model using respective positive count
    best_mcc3_all_val <- mini_preds[best_count3 + 1]
    submission0_ex_all_val <- fread("datasets/sample_submission.csv", header = TRUE, sep = ",", stringsAsFactors = FALSE)
    submission0_ex_all_val$Response <- as.numeric(predictedValues > best_mcc3_all_val)
    best_count3_all_val <- sum(submission0_ex_all_val$Response == 1)
    cat("Submission with all data by taking the amount of positives of average of overfit+validated threshold positives: ", best_count3_all_val, ". Threshold=", best_mcc3_all_val, "\n\n", sep = "")
    write.csv(submission0_ex_all_val, file = file.path(my_script_is_using, paste(my_script_subbed, "_all_val_", sprintf("%.06f", best_mcc3_all_val), "_", best_count3_all_val, ".csv", sep = "")), row.names = FALSE)
    
    # Create submissions using full trained model using total validated positive count
    best_mcc_extra <- mini_preds[sum(temp_positives) + 1]
    submission0_extra <- fread("datasets/sample_submission.csv", header = TRUE, sep = ",", stringsAsFactors = FALSE)
    submission0_extra$Response <- as.numeric(predictedValues > best_mcc_extra)
    best_count_extra <- sum(submission0_extra$Response == 1)
    cat("Submission with all data by taking the sum of positives of validated positives: ", best_count_extra, ". Threshold=", best_mcc_extra, "\n\n", sep = "")
    write.csv(submission0_extra, file = file.path(my_script_is_using, paste(my_script_subbed, "_extra_", sprintf("%.06f", best_mcc_extra), "_", best_count_extra, ".csv", sep = "")), row.names = FALSE)
    
  }
  
  
  if (length(lgbm) > 1) {
    
    # Do best feature listing
    cat("Cross-validated used features list (all used features to copy & paste):\n\n")
    mini_model <- copy(lgbm$FeatureImp)
    dput(mini_model$Feature)
    cat("\n\nCross-validated multipresence used features list (all used features to copy & paste):\n\n")
    mini_model <- mini_model[Freq == length(folds), ]
    dput(mini_model$Feature)
    cat("\n\nSee the screenshots for more accuracy about the gain\n\n\n")
    
  }
  
  sink()
  
  cat("```")
  return("Done")
  
}


AnalysisFunc(lgbm = temp_model,
             label = label,
             folds = folds,
             validationValues = temp_model$Validation[[1]],
             predictedValuesCV = temp_model$Testing[[1]],
             predictedValues = best_model$Testing)
